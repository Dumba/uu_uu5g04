<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
  <title>COVID-19</title>

  <script>
    if (!location.href.match(/^(about:|file:)/)) {
      var bplCookie = document.cookie.match(/(^|;\s*)uu\.app\.bpl=([^;]+)/);
      var bplSegmentCount = (bplCookie ? Number(bplCookie[2]) : null);
      if (typeof bplSegmentCount !== "number" || isNaN(bplSegmentCount) || bplSegmentCount < 0) bplSegmentCount = 2;
      var appBaseUrlPath = (location.pathname.split(/\//).slice(0, 1 + bplSegmentCount).join("/") + "/").replace(/\/+/g,
        "/").replace(/"/g, "");
      var appAssetsRelativeUrlPath = "public/0.0.0/";
      document.write(
        '<base href="' + appBaseUrlPath + appAssetsRelativeUrlPath + '" data-uu-app-base="' + appBaseUrlPath
        + '" data-uu-app-assets-base="' + appAssetsRelativeUrlPath + '">');
    }
  </script>

  <script src="https://cdn.plus4u.net/libs/systemjs/0.19.47/system.js"></script>
  <script>
    SystemJS.config({
      "paths": {
        "systemjs": "https://cdn.plus4u.net/libs/systemjs/0.19.47/system.js",
        "react": "https://cdn.plus4u.net/libs/react/16.8.6/react.min.js",
        "react-dom": "https://cdn.plus4u.net/libs/react-dom/16.8.6/react-dom.min.js",
        "create-react-class": "https://cdn.plus4u.net/libs/create-react-class/15.6.3/create-react-class.min.js",
        "prop-types": "https://cdn.plus4u.net/libs/prop-types/15.7.2/prop-types.min.js",

        "uu5g04": "https://cdn.plus4u.net/beta/uu-uu5g04/1.29.0-accept.3/uu5g04.min.js",
        "uu5g04-bricks": "https://cdn.plus4u.net/beta/uu-uu5g04/1.29.0-accept.3/uu5g04-bricks.min.js",
        "uu5g04-forms": "https://cdn.plus4u.net/beta/uu-uu5g04/1.29.0-accept.3/uu5g04-forms.min.js",
        "uu5g04-hooks": "https://cdn.plus4u.net/beta/uu-uu5g04/1.29.0-accept.3/uu5g04-hooks.min.js",

        "uu5chartg01": "https://cdn.plus4u.net/uu-uu5chartg01/1.0.0/uu5chartg01.min.js",
        "uu5amchartsg01": "https://cdn.plus4u.net/uu-uu5amchartsg01/1.0.0/uu5amchartsg01.min.js"
      }
    });
  </script>

  <style>
    .initial-loading {
      background-image: linear-gradient(6deg, #000 30%, #F44336 100%);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;

      display: flex;

      flex-direction: column;

      justify-content: center;

      align-items: center;
    }

    .initial-loading-spinner {
      display: block;
      position: relative;
      width: 216px;
      height: 216px;
      border-radius: 50%;
      border: 8px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.24);
      border-left-color: rgba(255, 255, 255, 0.24);

      animation: spin-revert 2s linear infinite; /* Chrome, Firefox 16+, IE 10+, Opera */
    }

    .initial-loading-spinner:before {
      content: "";
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      bottom: 20px;
      border-radius: 50%;
      border: 8px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.64);
      border-left-color: rgba(255, 255, 255, 0.64);

      animation: spin 1s linear infinite; /* Chrome, Firefox 16+, IE 10+, Opera */
    }

    .initial-loading-spinner:after {
      content: "";
      position: absolute;
      top: 50px;
      left: 50px;
      right: 50px;
      bottom: 50px;
      border-radius: 50%;
      border: 8px solid transparent;
      border-top-color: rgba(255, 255, 255, 0.89);
      border-left-color: rgba(255, 255, 255, 0.89);

      animation: spin 0.7s linear infinite; /* Chrome, Firefox 16+, IE 10+, Opera */
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg); /* Firefox 16+, IE 10+, Opera */
      }
      100% {
        transform: rotate(360deg); /* Firefox 16+, IE 10+, Opera */
      }
    }

    @keyframes spin-revert {
      0% {
        transform: rotate(0deg); /* Firefox 16+, IE 10+, Opera */
      }
      100% {
        transform: rotate(-360deg); /* Firefox 16+, IE 10+, Opera */
      }
    }

    .initial-loading-content {
      color: #fff;
      font-size: 32px;
      margin-top: 56px;
      font-weight: 700;
    }
  </style>
</head>
<body>

<div id="uu5Example">
  <div class="initial-loading clear-sans">
    <div class="initial-loading-spinner"></div>
    <div class="initial-loading-content">COVID-19</div>
  </div>
</div>

<script src="https://cdn.plus4u.net/uu-appg01-template/1.0.0/in-browser-transpilation.min.js"></script>
<script type="text/babel">
  import UU5 from "uu5g04";
  import "uu5g04-bricks";
  import "uu5g04-forms";
  import { useState, useEffect, useCallback, createComponent, useData, useScreenSize } from "uu5g04-hooks";
  import "uu5chartg01";
  import "uu5amchartsg01";

  UU5.Environment.disableStatistics();

  let defaultCountry = "Czechia";

  const Calls = {
    load() {
      return new Promise((resolve, reject) => {
        fetch("https://corona.lmao.ninja/countries")
          .then(response => response.json())
          .then(resolve);
      });
    },

    loadWorld() {
      return new Promise((resolve, reject) => {
        fetch("https://corona.lmao.ninja/all")
          .then(response => response.json())
          .then(resolve);
      });
    },

    loadCountryHistory({ country } = {}) {
      return new Promise((resolve, reject) => {
        fetch("https://corona.lmao.ninja/v2/historical/" + (country))
          .then(response => response.json())
          .then(resolve);
      });
    }
  };

  const TYPES = {
    cases: "Nakaženo",
    todayCases: "Dnes nakaženo",
    deaths: "Zemřelo",
    todayDeaths: "Dnes zemřelo",
    recovered: "Vyléčeno",
    critical: "Kritické"
  };

  const CountryList = createComponent({
    render({ data }) {
      const { screenSize } = useScreenSize();
      const [index, setIndex] = useState(0);
      const [filter, setFilter] = useState("todayCases");

      const sortedData = [...data].sort((a, b) => {
        if (a[filter] < b[filter]) return 1;
        if (a[filter] > b[filter]) return -1;
        return 0;
      });

      const selectedData = sortedData.slice(0, (index + 1) * 10);
      let component;

      if (screenSize === "xs") {
        component = (
          <div className={UU5.Common.Css.css`display: flex;flex-wrap: wrap;justify-content: center;margin-top: 8px;`}>
            {selectedData.map((item, i) => (
              <CountryBox key={item.country} order={i + 1} {...item} header={item.country} />
            ))}
          </div>
        );
      } else {
        const isToday = /^today/.test(filter);

        const series = [
          {
            "id": isToday ? "todayCases" : "cases",
            "type": "ColumnSeries",
            "dataFields": {
              "valueY": isToday ? "todayCases" : "cases",
              "categoryX": "country"
            },
            "tooltipText": "[{categoryX}: bold]{valueY}[/]",
            "tooltip": {
              "pointerOrientation": "vertical"
            },
            fill: "#F44336"
          },
          {
            "id": isToday ? "todayDeaths" : "deaths",
            "type": "ColumnSeries",
            "dataFields": {
              "valueY": isToday ? "todayDeaths" : "deaths",
              "categoryX": "country"
            },
            "tooltipText": "[{categoryX}: bold]{valueY}[/]",
            "tooltip": {
              "pointerOrientation": "vertical"
            },
            fill: "#212121"
          }
        ];

        if (!isToday) {
          series.push({
            "id": "recovered",
            "type": "ColumnSeries",
            "dataFields": {
              "valueY": "recovered",
              "categoryX": "country"
            },
            "tooltipText": "[{categoryX}: bold]{valueY}[/]",
            "tooltip": {
              "pointerOrientation": "vertical"
            },
            fill: "#4CAF50"
          });
        }

        component = (
          <UU5.AmCharts.Chart
            height="400px"
            {...{
              "type": "XYChart",
              "config": {
                "series": series,
                "cursor": {
                  "type": "XYCursor",
                  "behaviour": "zoomY",
                  "lineX": {
                    "disabled": true
                  }
                },
                "xAxes": [
                  {
                    "type": "CategoryAxis",
                    "dataFields": {
                      "category": "country"
                    }
                  }
                ],
                "yAxes": [
                  {
                    "type": "ValueAxis"
                  }
                ],
                "scrollbarX": {
                  "type": "Scrollbar"
                },
                "data": selectedData
              }
            }}
          />
        );
      }

      const handleChange = useCallback(({ value }) => {
        if (value !== filter) {
          setIndex(0);
          setFilter(value);
        }
      });

      return (
        <div>
          <UU5.Forms.Select value={filter} onChange={handleChange}>
            {["todayCases", "cases", "todayDeaths", "deaths", "recovered", "critical"].map(key => (
              <UU5.Forms.Select.Option key={key} value={key} content={TYPES[key]} />
            ))}
          </UU5.Forms.Select>
          {component}
          {selectedData.length < data.length && (
            <div className={UU5.Common.Css.css`text-align: center;`}>
              <UU5.Bricks.Button
                content="Další"
                bgStyle="transparent"
                colorSchema="primary"
                onClick={() => setIndex(index + 1)}
              />
            </div>
          )}
        </div>
      )
    }
  });

  const WorldInfo = createComponent({
    render() {
      const { component, data } = useLoader({ onLoad: Calls.loadWorld });
      return component || (
        <div className={UU5.Common.Css.css`text-align: center;`}>
          <CountryBox {...data} header="World" />
        </div>
      )
    }
  });

  const World = createComponent({
    render({ data }) {
      return (
        <UU5.Bricks.Section header="Svět">
          <WorldInfo />
          <CountryList data={data} />
        </UU5.Bricks.Section>
      )
    }
  });

  const MIN_INTERVAL = 1000 / 80;

  function useCounter({ value, valueStart = 0, duration = 500 }) {
    const [counter, setCounter] = useState(valueStart);

    useEffect(() => {
      if (value) {
        const repeat = duration / MIN_INTERVAL;
        const num = Math.ceil((value - (counter || valueStart)) / repeat);

        // setCounter(valueStart);

        let interval;
        const timeout = setTimeout(() => {
          interval = setInterval(() => {
            setCounter(counter => {
              let newCounter = counter + num;
              if (num > 0 ? newCounter >= value : newCounter <= value) {
                newCounter = value;
                clearInterval(interval);
              }
              return newCounter;
            });
          }, MIN_INTERVAL);
        }, 300);

        return () => {
          clearTimeout(timeout);
          clearInterval(interval);
        }
      }
    }, [value]);

    return counter;
  }

  const Counter = createComponent({
    render(props) {
      const counter = useCounter(props);
      return UU5.Common.Tools.formatNumber(counter, { thousandSeparator: "\xA0" });
    }
  });

  const Box = createComponent({
    render({ colorSchema, value, children }) {
      return (
        <div
          className={UU5.Common.Css.css`
            width: 80px;
            height: 80px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            border-radius: 8px;
            margin: 4px;
          ` + ` uu5-common-bg-style-filled color-schema-${UU5.Environment.getColorSchema(colorSchema)}`}
        >
          <div className={UU5.Common.Css.css`margin-bottom: 8px;`}>{children}</div>
          <div className={UU5.Common.Css.css`font-size: 1.3em`}>
            <b><Counter value={value} /></b>
          </div>
        </div>
      )
    }
  });

  const Row = createComponent({
    render({ colorSchema, big, bold, value, title }) {
      return (
        <div
          title={title}
          className={UU5.Common.Css.css`
          font-size: ${big ? "1.3em" : undefined};
          padding: 4px 8px;
          width: 100%;
          font-weight: ${bold ? "bold" : undefined};
        ` + ` uu5-common-bg-style-filled color-schema-${UU5.Environment.getColorSchema(colorSchema)}`}
        >
          <Counter value={value} />
        </div>
      );
    }
  });

  const CountryBox = createComponent({
    render({ order, header, cases, deaths, todayCases, todayDeaths, recovered, critical }) {
      return (
        <div
          className={UU5.Common.Css.css`
            width: 104px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            border-radius: 8px;
            margin: 4px 2px;
            overflow: hidden;
          ` + ` uu5-common-bg-style-outline`}
        >
          <div
            className={UU5.Common.Css.css`
              padding: 4px 8px;
              width: 100%;
              flex: 1;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
            ` + ` uu5-common-bg-style-filled color-schema-${UU5.Environment.getColorSchema("blue-rich")}`}
          >
            {order && <UU5.Bricks.Badge colorSchema="white">{order}</UU5.Bricks.Badge>}
            <div>{header}</div>
          </div>

          <Row value={cases} title={TYPES.cases} colorSchema="red-rich" big bold />
          {todayCases != null && <Row value={todayCases} title={TYPES.todayCases} colorSchema="red-rich" big />}
          <Row value={deaths} title={TYPES.deaths} colorSchema="black" big bold />
          {todayDeaths != null && <Row value={todayDeaths} title={TYPES.todayDeaths} colorSchema="black" big />}
          <Row value={recovered} title={TYPES.recovered} colorSchema="green" />
          {critical != null && <Row value={critical} title={TYPES.critical} colorSchema="red" />}
        </div>
      )
    }
  });

  function getItem(d, timeline, delta, item) {
    item = item || {
      date: new Date(d),
      cases: timeline.cases[d],
      deaths: timeline.deaths[d]
    };
    if (timeline.recovered) item.recovered = timeline.recovered[d];

    if (delta) {
      const prevDate = new Date(item.date);
      prevDate.setDate(prevDate.getDate() - 1);
      const prevD = UU5.Common.Tools.formatDate(prevDate, "m/d/y");
      if (timeline.cases[prevD] != null) {
        item.cases = item.cases - timeline.cases[prevD];
        item.deaths = item.deaths - timeline.deaths[prevD];
        if (timeline.recovered) item.recovered = item.recovered - timeline.recovered[prevD];
      }
    }

    return item;
  }

  const CountryHistory = createComponent({
    render({ country, today }) {
      let { component, data } = useLoader({ onLoad: Calls.loadCountryHistory, dtoIn: { country } });
      const [delta, setDelta] = useState(true);

      if (data) {
        const chartData = [];
        let canAdd = false;
        for (let d in data.timeline.cases) {
          if (canAdd || data.timeline.cases[d]) {
            canAdd = true;
            chartData.push(getItem(d, data.timeline, delta));
          }
        }

        const todayItem = getItem(undefined, data.timeline, delta, {
          date: new Date(), cases: today.cases, deaths: today.deaths, recovered: today.recovered
        });
        chartData.push(todayItem);

        component = (
          <UU5.Common.Fragment>
            <div className={UU5.Common.Css.css`text-align: center;margin-top: 32px;`}>
              <UU5.Bricks.SwitchSelector
                items={[{ value: "false", content: "Kompletně" }, { value: "true", content: "Přírůstkově" }]}
                value={delta + ""}
                onChange={({ value }) => setDelta(!delta)}
              />
            </div>
            <UU5.AmCharts.Chart
              height="400px"
              {...{
                "type": "XYChart",
                "config": {
                  "series": [
                    {
                      "id": "cases",
                      "type": "LineSeries",
                      "dataFields": {
                        "valueY": "cases",
                        "dateX": "date"
                      },
                      "tooltipText": "{valueY}",
                      "stroke": UU5.Environment.colors.red.c500,
                      "strokeWidth": 2,
                      "minBulletDistance": 10,
                      "tooltip": {
                        pointerOrientation: "vertical",
                        "background": {
                          "cornerRadius": 20,
                          "fillOpacity": 0.5
                        },
                        "label": {
                          padding: [12, 12, 12, 12]
                        }
                      },
                      fill: UU5.Environment.colors.red.c500
                    },
                    {
                      "id": "deaths",
                      "type": "LineSeries",
                      "dataFields": {
                        "valueY": "deaths",
                        "dateX": "date"
                      },
                      "tooltipText": "{valueY}",
                      "stroke": UU5.Environment.colors.grey.c900,
                      "strokeWidth": 2,
                      "minBulletDistance": 0,
                      "tooltip": {
                        pointerOrientation: "vertical",
                        "background": {
                          "cornerRadius": 20,
                          "fillOpacity": 0.5
                        },
                        "label": {
                          padding: [12, 12, 12, 12]
                        }
                      },
                      "fill": UU5.Environment.colors.grey.c900
                    },
                    {
                      "id": "recovered",
                      "type": "LineSeries",
                      "dataFields": {
                        "valueY": "recovered",
                        "dateX": "date"
                      },
                      "tooltipText": "{value}",
                      "stroke": UU5.Environment.colors.green.c500,
                      "strokeWidth": 2,
                      "minBulletDistance": 0,
                      "tooltip": {
                        "pointerOrientation": "vertical",
                        "background": {
                          "cornerRadius": 20,
                          "fillOpacity": 0.5
                        },
                        "label": {
                          padding: [12, 12, 12, 12]
                        }
                      },
                      fill: UU5.Environment.colors.green.c500
                    }
                  ],
                  "cursor": {
                    "type": "XYCursor",
                    "behaviour": "panXY"
                  },
                  "scrollbarX": {
                    "type": "XYChartScrollbar",
                    "series": [
                      "cases"
                    ]
                  },
                  "xAxes": [
                    {
                      "type": "DateAxis",
                      "dataFields": {
                        "category": "label"
                      }
                    }
                  ],
                  "yAxes": [
                    {
                      "type": "ValueAxis"
                    }
                  ],
                  "data": chartData
                }
              }}
            />
          </UU5.Common.Fragment>
        );
      }

      return component;
    }
  });

  const States = createComponent({
    render({ data }) {
      const [country, setCountry] = useState(defaultCountry);
      const countryItem = data.find(({ country: ctry }) => ctry === country);

      return (
        <div>
          <UU5.Forms.TagSelect
            value={country}
            availableTags={data.map(item => ({ value: item.country }))}
            onChange={opt => {
              opt.component.onChangeDefault(opt);
              setCountry(opt.value[0]);
            }}
          />

          <div className={UU5.Common.Css.css`display: flex; justify-content: center; flex-wrap: wrap;margin-top: 8px;`}>
            <Box value={countryItem.cases} children="Nakaženo" colorSchema="red-rich" />
            <Box value={countryItem.deaths} children="Zemřelo" colorSchema="black" />
            <Box value={countryItem.recovered} children="Vyléčeno" colorSchema="green-rich" />
          </div>
          <div className={UU5.Common.Css.css`display: flex; justify-content: center; flex-wrap: wrap;`}>
            <Box value={countryItem.todayCases} children="Dnes" colorSchema="red-rich" />
            <Box value={countryItem.todayDeaths} children="Dnes" colorSchema="black" />
            <Box value={countryItem.critical} children="Kritické" colorSchema="red" />
          </div>

          <CountryHistory country={country} today={countryItem} key={country} />
        </div>
      )
    }
  });

  function useLoader(params) {
    const { viewState, asyncData } = useData(params);
    let component;

    switch (viewState) {
      case "load":
        component = <UU5.Bricks.Loading />;
        break;
      case "error":
        component = <UU5.Bricks.Error content="Error during loading" />;
        break;
    }

    return { component, data: asyncData };
  }

  const Covid = createComponent({
    render(props) {
      const { component, data } = useLoader({ onLoad: Calls.load });

      return component || (
        <UU5.Common.Fragment>
          <States data={data} />
          <World data={data} />
        </UU5.Common.Fragment>
      );
    }
  });

  const Page = createComponent({
    render() {
      return (
        <UU5.Bricks.Container header="Covid-19" level={1}>
          <Covid />
        </UU5.Bricks.Container>
      );
    }
  });

  UU5.Common.DOM.render(<Page />, document.getElementById('uu5Example'));
</script>
</body>
</html>
